{% extends 'base.html.twig' %}

{% block title %}{{ symbol }} - Additional Metrics{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .metric-card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-card .card-header {
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        .esg-score {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
        }
        .score-high {
            background-color: #28a745;
        }
        .score-medium {
            background-color: #ffc107;
        }
        .score-low {
            background-color: #dc3545;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #007bff;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ symbol }} - Additional Metrics</h1>
            <div>
                <a href="{{ path('app_additional_metrics', {'symbol': symbol}) }}" class="btn btn-outline-primary active">Overview</a>
                <a href="{{ path('app_esg_dashboard', {'symbol': symbol}) }}" class="btn btn-outline-primary">ESG</a>
                <a href="{{ path('app_sec_filings', {'symbol': symbol}) }}" class="btn btn-outline-primary">SEC Filings</a>
                <a href="{{ path('app_insider_trading', {'symbol': symbol}) }}" class="btn btn-outline-primary">Insider Trading</a>
                <a href="{{ path('app_institutional_ownership', {'symbol': symbol}) }}" class="btn btn-outline-primary">Institutional Ownership</a>
                <a href="{{ path('app_analyst_ratings', {'symbol': symbol}) }}" class="btn btn-outline-primary">Analyst Ratings</a>
            </div>
        </div>

        <div class="row">
            <!-- ESG Score Card -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between">
                            <span>ESG Scores</span>
                            <a href="{{ path('app_esg_dashboard', {'symbol': symbol}) }}" class="text-white">View Details</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if summary.esgData.error is defined %}
                            <div class="alert alert-warning">{{ summary.esgData.error }}</div>
                        {% else %}
                            <div class="row text-center">
                                <div class="col">
                                    {% set overallClass = summary.esgData.overallScore > 70 ? 'score-high' : (summary.esgData.overallScore > 40 ? 'score-medium' : 'score-low') %}
                                    <div class="esg-score {{ overallClass }}">{{ summary.esgData.overallScore|number_format(1) }}</div>
                                    <div class="mt-2">Overall</div>
                                </div>
                                <div class="col">
                                    {% set envClass = summary.esgData.environmentalScore > 70 ? 'score-high' : (summary.esgData.environmentalScore > 40 ? 'score-medium' : 'score-low') %}
                                    <div class="esg-score {{ envClass }}">{{ summary.esgData.environmentalScore|number_format(1) }}</div>
                                    <div class="mt-2">Environmental</div>
                                </div>
                                <div class="col">
                                    {% set socialClass = summary.esgData.socialScore > 70 ? 'score-high' : (summary.esgData.socialScore > 40 ? 'score-medium' : 'score-low') %}
                                    <div class="esg-score {{ socialClass }}">{{ summary.esgData.socialScore|number_format(1) }}</div>
                                    <div class="mt-2">Social</div>
                                </div>
                                <div class="col">
                                    {% set govClass = summary.esgData.governanceScore > 70 ? 'score-high' : (summary.esgData.governanceScore > 40 ? 'score-medium' : 'score-low') %}
                                    <div class="esg-score {{ govClass }}">{{ summary.esgData.governanceScore|number_format(1) }}</div>
                                    <div class="mt-2">Governance</div>
                                </div>
                            </div>
                            <div class="text-muted mt-3 text-center">
                                <small>Last updated: {{ summary.esgData.lastUpdated|date('Y-m-d') }}</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Analyst Ratings Card -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between">
                            <span>Analyst Ratings</span>
                            <a href="{{ path('app_analyst_ratings', {'symbol': symbol}) }}" class="text-white">View Details</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if summary.analystRatings.error is defined %}
                            <div class="alert alert-warning">{{ summary.analystRatings.error }}</div>
                        {% else %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Consensus</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Buy:</span>
                                        <span>{{ summary.analystRatings.consensus.ratingDistribution.Buy|default(0) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Hold:</span>
                                        <span>{{ summary.analystRatings.consensus.ratingDistribution.Hold|default(0) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Sell:</span>
                                        <span>{{ summary.analystRatings.consensus.ratingDistribution.Sell|default(0) }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>Price Target</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Low:</span>
                                        <span>${{ summary.analystRatings.consensus.priceTargets.min|default(0)|number_format(2) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Average:</span>
                                        <span>${{ summary.analystRatings.consensus.priceTargets.average|default(0)|number_format(2) }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>High:</span>
                                        <span>${{ summary.analystRatings.consensus.priceTargets.max|default(0)|number_format(2) }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- SEC Filings Card -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between">
                            <span>Recent SEC Filings</span>
                            <a href="{{ path('app_sec_filings', {'symbol': symbol}) }}" class="text-white">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if summary.secFilings.error is defined %}
                            <div class="alert alert-warning">{{ summary.secFilings.error }}</div>
                        {% else %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for filing in summary.secFilings|slice(0, 5) %}
                                            <tr>
                                                <td>{{ filing.filingType }}</td>
                                                <td>{{ filing.filingDate }}</td>
                                                <td>
                                                    {% if filing.documentUrl %}
                                                        <a href="{{ filing.documentUrl }}" target="_blank">{{ filing.description|default('View Document') }}</a>
                                                    {% else %}
                                                        {{ filing.description|default('N/A') }}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center">No filings available</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Insider Trading Card -->
            <div class="col-md-6">
                <div class="card metric-card">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex justify-content-between">
                            <span>Recent Insider Transactions</span>
                            <a href="{{ path('app_insider_trading', {'symbol': symbol}) }}" class="text-dark">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if summary.insiderTransactions.error is defined %}
                            <div class="alert alert-warning">{{ summary.insiderTransactions.error }}</div>
                        {% else %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Insider</th>
                                            <th>Position</th>
                                            <th>Type</th>
                                            <th>Shares</th>
                                            <th>Value</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in summary.insiderTransactions|slice(0, 5) %}
                                            <tr>
                                                <td>{{ transaction.insiderName }}</td>
                                                <td>{{ transaction.position }}</td>
                                                <td>{{ transaction.transactionType }}</td>
                                                <td>{{ transaction.shares|number_format }}</td>
                                                <td>${{ transaction.transactionValue|default(0)|number_format }}</td>
                                                <td>{{ transaction.transactionDate }}</td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="6" class="text-center">No transactions available</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Institutional Ownership Card -->
            <div class="col-md-12">
                <div class="card metric-card">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between">
                            <span>Top Institutional Holders</span>
                            <a href="{{ path('app_institutional_ownership', {'symbol': symbol}) }}" class="text-white">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if summary.institutionalHolders.error is defined %}
                            <div class="alert alert-warning">{{ summary.institutionalHolders.error }}</div>
                        {% else %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Institution</th>
                                            <th>Shares</th>
                                            <th>Value</th>
                                            <th>% Owned</th>
                                            <th>Change</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for holder in summary.institutionalHolders|slice(0, 5) %}
                                            <tr>
                                                <td>{{ holder.institutionName }}</td>
                                                <td>{{ holder.sharesHeld|number_format }}</td>
                                                <td>${{ holder.valueHeld|default(0)|number_format }}</td>
                                                <td>{{ holder.percentageOwned|number_format(2) }}%</td>
                                                <td class="{{ holder.percentageChange > 0 ? 'text-success' : (holder.percentageChange < 0 ? 'text-danger' : '') }}">
                                                    {% if holder.percentageChange > 0 %}
                                                        +{{ holder.percentageChange|number_format(2) }}%
                                                    {% elseif holder.percentageChange < 0 %}
                                                        {{ holder.percentageChange|number_format(2) }}%
                                                    {% else %}
                                                        0.00%
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center">No institutional holders available</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Add any JavaScript for interactive charts here
    </script>
{% endblock %}
